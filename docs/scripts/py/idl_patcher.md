# idl_patcher.py

## Overview

`idl_patcher.py` is an advanced IDL parser and code generator that parses IDL files and patches PublisherApp files with default data assignments. It uses a two-stage parsing approach and smart data generation based on field names and types.

## Purpose

- Parses IDL files to understand data structures
- Generates C++ code for initializing data structures
- Patches PublisherApp files with default data assignments
- Supports complex types: structs, enums, unions, typedefs, arrays, sequences

## How It Works

### Stage 1: Type Discovery
- Scans all `.idl` files in `IDL/` directory
- Discovers struct, enum, union, and typedef declarations
- Builds a type registry with module scoping

### Stage 2: Body Parsing
- Parses struct fields, enum values, union cases
- Resolves typedef chains
- Builds complete type definitions

### Code Generation
- Generates C++ assignment code based on type and field name
- Uses smart defaults (e.g., latitude/longitude for location fields)
- Handles arrays, sequences, nested structures

### File Patching
- Finds `/* Initialize your structure here */` comments
- Injects generated code between BEGIN/END markers
- Creates backups before modification

## Usage

### Basic Usage

```bash
cd scripts/py
python3 idl_patcher.py
```

### From Project Root

```bash
python3 scripts/py/idl_patcher.py
```

### Via Shell Script

```bash
bash scripts/sh/idl_patcher.sh
```

## Smart Data Generation

The script generates context-aware default values:

- **Location fields**: `latitude` → `37.7749`, `longitude` → `-122.4194`
- **Time fields**: `seconds` → timestamp, `nanoseconds` → `500000000UL`
- **Status fields**: Enum values like `IDLE`, `PATROL`
- **ID fields**: Context-aware IDs based on field name
- **Fallback**: Uses type-based defaults if no field name match

## Generated Code Format

```cpp
// --- BEGIN AUTOGENERATED IDL PATCH (v9) ---
sample_.latitude(37.7749);
sample_.longitude(-122.4194);
sample_.altitude(100.0f);
sample_.speed_mps(15.5f);
// ... more assignments ...
// --- END AUTOGENERATED IDL PATCH (v9) ---
```

## Output Files

- Modified `*PublisherApp.cxx` files
- Backup files with `.idl_patcher_v9.backup` suffix

## Requirements

- Python 3.x
- IDL files in `IDL/` directory
- Generated `*_idl_generated/` directories

## Integration

This script is called by:
- `setup.sh` - During IDL patcher setup phase (STEP 5)
- `scripts/sh/idl_patcher.sh` - Standalone execution
- `scripts/sh/dynamic_ALL.sh` - Complete workflow

## Execution Order

**Important**: IDL patcher should run **before** JSON patcher:

1. First: `idl_patcher.py` - Creates AUTOGENERATED blocks
2. Then: `json_patcher.py` - Replaces blocks with JSON reading

## Notes

- Supports nested structures and complex types
- Handles module scoping correctly
- Idempotent: safe to run multiple times
- Creates detailed structure information output
- Version 9.4.1 with smart data generation

